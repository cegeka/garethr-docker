description "start and stop <%= @title %> in docker"
author "Gareth Rushgrove"

start on (started docker)
stop on runlevel [!2345]

setuid root

respawn
respawn limit 5 20

<%
  args = []

  args.concat ['-u', @username] if @username

  args.concat ['-h', @hostname] if @hostname

  args.concat ['-n', 'false'] if @disable_network

  @dns_array.each do |addr|
    args.concat ['-dns', addr]
  end

  @env_array.each do |env|
    args.concat ['-e', env]
  end

  @ports_array.each do |port|
    args.concat ['-p', port]
  end

  @volumes_array.each do |volume|
    args.concat ['-v', volume]
  end

  @volumes_from.each do |volume_from|
    args.concat ['--volumes-from', volume_from]
  end

  args.concat ['-m', @memory_limit]

  @links_array.each do |link|
    args.concat ['--link', link]
  end

  args.concat ['-name', @name] if @use_name

  @lxc_conf_array.each do |lxc_conf|
    args.concat ['--lxc-conf', lxc_conf]
  end

  args << @image

  args << @command if @command

  args.map!(&:to_s) # fix a ruby 1.9.3 issue where shellwords can't handle symbols
  require 'shellwords'
-%>

exec docker run <%= Shellwords.shelljoin(args) %>
